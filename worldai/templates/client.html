<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WorldAI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
    <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'/>
    <style>
      body {
	  font-family: 'Open Sans';
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
   </head>

  <body onload="loadAction()">
    <div style="display:flex;">
      <div style='width:50%;height:90vh;'>    
        <div id="messages" style="width:90%;height:80%;border:1px solid lightgrey;padding-top:2em;padding-left:2em;overflow-y:auto;">
        </div>
        <br>
        <div style='width:100%;text-align:center;vertical-align:middle;'>
          <div>
            <textarea id="user" name="user" cols="60" rows="2"></textarea>
          </div>
          <div>        
            <button id="send">Send</button>
          </div>
          <div>        
            <button id="clear" onclick="clearThread()">Clear Thread</button>
          </div>
        </div>
      </div>
      <div style='flex-grow:1;'>
        <iframe id="view" 
                style="width:100%;height:100%"></iframe>
      </div>
    </div>    
  </body>
  <script>
    const view_frame = document.getElementById("view")    
    const messages = document.getElementById("messages")
    const user_input = document.getElementById("user")
    const send_button = document.getElementById("send")
    const url = "{{ url_for('worldai.chat_api', session_id=session_id) }}";

    function addUserMessage(message) {
        messages.innerHTML +=
            '<p><b>You</b><br>' + message + '</p>';
    }
    
    function addAssistantMessage(message) {
        messages.innerHTML +=
            '<p><b>Assistant</b><br>' + message + '</p>';
    }

    
    in_progress = false;
    current_view = "{{ url_for('worldai.view') }}";
    
    const loadAction = async() => {
        if (in_progress) {
            return
        }
        in_progress = true;
        const response = await fetch(url);
        const values = await response.json();
        view_frame.src = values["view"];      
        const msg_list = values["messages"];
        if (msg_list.length == 0) {
            addAssistantMessage("Hello, welcome to world builder!<br>Enter a request in the text box below.");
        }
        for (i in msg_list) {
            addUserMessage(msg_list[i]["user"]);
            addAssistantMessage(msg_list[i]["assistant"]);
        }
        messages.scrollTop = messages.scrollHeight;
        in_progress = false;
    }
    
    const postAction = async() => {
        if (in_progress) {
            return
        }
        in_progress = true;
        text = user_input.value;
        user_input.value = 'running...';
        user_input.disabled = true;
        send_button.disbled = true;
        addUserMessage(text);
        messages.scrollTop = messages.scrollHeight;
        
        const response = await fetch(url, {
            method: 'POST',
            body: '{ "user": "' + text + '"}',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        const values = await response.json();
        console.log(values);
        user_input.value = '';
        user_input.disabled = false;
        send_button.disbled = false;
        addAssistantMessage(values["assistant"]);
        in_progress = false;
        messages.scrollTop = messages.scrollHeight;

      if (current_view != values["view"] || values["changes"]) {
        view_frame.src = values["view"];
          current_view = values["view"];
          console.log(`view: ${values["view"]}`);
        }
    }
    function keyEvent(key) {
        if (key.keyCode == 13) {
            postAction();
            key.preventDefault();
        }
    }
    user_input.addEventListener("keydown", keyEvent);
    send_button.onclick = postAction;

    async function clearThread() {
        const response = await fetch(url, {
            method: 'POST',
            body: '{ "command": "clear_thread" }',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        document.location.reload();
    }
    
  </script>
</html>

