<!DOCTYPE html>
<html lang="en">
  <head>
    <title>WorldAI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"/>
    <link href='https://fonts.googleapis.com/css?family=Open Sans' rel='stylesheet'/>
    <style>
      body {
	  font-family: 'Open Sans';
      }
    </style>
    <meta name="viewport" content="width=device-width, initial-scale=1">
   </head>

  <body>
    <div style='width:100%;height:90vh;verticle-align:text-bottom;border:3px solid green;'>    
      <div id="messages" style="width:90%;height:80%;border:1px;padding-top:2em;padding-left:5em;overflow-y:auto;">
      </div>
      <br>
      <div style='width:100%;text-align:center;vertical-align:middle;'>
        <div>
          <textarea id="user" name="user" cols="60" rows="2"></textarea>
        </div>
        <div>        
          <button id="send">Send</button>
        </div>
      </div>
    </div>      
  </body>
  <script>
    const messages = document.getElementById("messages")
    const user_input = document.getElementById("user")
    const send_button = document.getElementById("send")
    const url = "{{ url_for('worldai.chat', session_id=session_id) }}";

    function addUserMessage(message) {
        messages.innerHTML +=
            '<p><b>You</b><br>' + message + '</p>';
    }
    
    function addAssistantMessage(message) {
        messages.innerHTML +=
            '<p><b>Assistant</b><br>' + message + '</p>';
    }

    
    in_progress = false;
    
    const loadAction = async() => {
        if (in_progress) {
            return
        }
        in_progress = true;
        const response = await fetch(url);
        const values = await response.json();
        const messages = values["messages"];
        for (i in messages) {
            addUserMessage(messages[i]["user"]);
            addAssistantMessage(messages[i]["assistant"]);
        }
        in_progress = false;        
    }
    loadAction()

    const postAction = async() => {
        if (in_progress) {
            return
        }
        in_progress = true;
        text = user_input.value;
        user_input.value = ''
        const response = await fetch(url, {
            method: 'POST',
            body: '{ "user": "' + text + '"}',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        addUserMessage(text);        
        const values = await response.json();
        addAssistantMessage(values["assistant"]);
        in_progress = false;
        messages.scrollTop = messages.scrollHeight;
    }
    function keyEvent(key) {
        if (key.keyCode == 13) {
            postAction();
            key.preventDefault();
        }
    }
    user_input.addEventListener("keydown", keyEvent);
    send_button.onclick = postAction;    
    
  </script>
</html>

